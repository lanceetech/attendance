/**
 * @fileoverview Firestore Security Rules for ClassSync.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles
 * and allows public read access to course units, classes, classrooms, and feedback.
 * Timetable data is also publicly accessible. Write access to user
 * profiles is restricted to the owning user. Other data collections are publicly
 * readable but writes are generally disallowed except where noted.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profiles.
 * - /units/{unitId}: Stores information about course units.
 * - /classes/{classId}: Stores information about scheduled class sessions.
 * - /classes/{classId}/attendance/{attendanceId}: Stores attendance records for classes.
 * - /classrooms/{roomId}: Stores information about classrooms.
 * - /feedback/{feedbackId}: Stores user feedback.
 * - /studentTimetable/{entryId}: Stores student timetable data.
 * - /lecturerTimetable/{entryId}: Stores lecturer timetable data.
 *
 * Key Security Decisions:
 * - User profiles are only writable by the owning user.
 * - Public read access is granted to units, classes, classrooms, feedback,
 *   and timetable data to allow easy access to core application data.
 * - Attendance records are not secured for writes in this prototype version,
 *   but owner-only write rules should be implemented.
 * - List operations are allowed for owners on user-scoped subcollections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) User with matching ID can create their profile.
     * @allow (get, update, delete) Authenticated user can read/update/delete their own profile.
     * @deny (create, update, delete) Authenticated user cannot modify another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows anyone to read unit data.
     * @path /units/{unitId}
     * @allow (get, list) Anyone can read unit data.
     * @deny (create, update, delete) No one can modify unit data.
     * @principle Allows public read access.
     */
    match /units/{unitId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read class data.
     * @path /classes/{classId}
     * @allow (get, list) Anyone can read class data.
     * @deny (create, update, delete) No one can modify class data.
     * @principle Allows public read access.
     */
    match /classes/{classId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

       /**
        * @description Allows authenticated users to manage attendance records for a class.
        * @path /classes/{classId}/attendance/{attendanceId}
        * @allow (get, list) Anyone can read attendance data.
        * @deny (create, update, delete) No one can modify attendance data.
        * @principle Owner-only write rules should be implemented.
        */
       match /attendance/{attendanceId} {
            allow get: if true;
            allow list: if true;
            allow create: if false;  // TODO: Implement owner-only write rules.
            allow update: if false;  // TODO: Implement owner-only write rules.
            allow delete: if false;  // TODO: Implement owner-only write rules.
       }
    }

    /**
     * @description Allows anyone to read classroom data.
     * @path /classrooms/{roomId}
     * @allow (get, list) Anyone can read classroom data.
     * @deny (create, update, delete) No one can modify classroom data.
     * @principle Allows public read access.
     */
    match /classrooms/{roomId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read feedback data.
     * @path /feedback/{feedbackId}
     * @allow (get, list) Anyone can read feedback data.
     * @deny (create, update, delete) No one can modify feedback data.
     * @principle Allows public read access.
     */
    match /feedback/{feedbackId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read student timetable data.
     * @path /studentTimetable/{entryId}
     * @allow (get, list) Anyone can read student timetable data.
     * @deny (create, update, delete) No one can modify student timetable data.
     * @principle Allows public read access.
     */
    match /studentTimetable/{entryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read lecturer timetable data.
     * @path /lecturerTimetable/{entryId}
     * @allow (get, list) Anyone can read lecturer timetable data.
     * @deny (create, update, delete) No one can modify lecturer timetable data.
     * @principle Allows public read access.
     */
    match /lecturerTimetable/{entryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}