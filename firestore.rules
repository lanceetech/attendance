rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Verifies user authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user's UID matches the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user's UID matches the existing document's userId field and that the document exists.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user ownership and document existence for updates/deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'admin' role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces role-based access control.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'admin';
    }

    /**
     * @description Checks if the user has the 'lecturer' role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces role-based access control.
     */
    function isLecturer() {
        return isSignedIn() && request.auth.token.role == 'lecturer';
    }

    /**
     * @description Root match - no read or write allowed
     * @path /
     * @allow None
     * @deny All
     * @principle Root access is forbidden, ensure that all access has a subpath.
     */
    match /{document=**} {
       allow read: if false;
       allow write: if false;
    }

    /**
     * @description Rules for user profiles. Users can read their own profile, and create their profile if the UID matches.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read any user profile.
     * @allow (create) Authenticated user can create their own profile if the UID matches.
     * @deny (create) Authenticated user cannot create a profile for another user.
     * @deny (update) Authenticated user cannot update another user's profile.
     * @deny (delete) No user can delete a profile.
     * @principle Enforces user-owned profiles, prevents unauthorized modification.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Rules for course units. Only admins can create, update, or delete units. Everyone can read units.
     * @path /units/{unitId}
     * @allow (get) Any user can read a unit.
     * @allow (create) Only admins can create a unit.
     * @deny (create) Non-admins cannot create units.
     * @deny (update) Non-admins cannot update units.
     * @deny (delete) Non-admins cannot delete units.
     * @principle Restricts unit management to admins.
     */
    match /units/{unitId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for scheduled class sessions. Only admins can create, update, or delete classes. Everyone can read.
     * @path /classes/{classId}
     * @allow (get) Any user can read a class.
     * @allow (create) Only admins can create a class.
     * @deny (create) Non-admins cannot create classes.
     * @deny (update) Non-admins cannot update classes.
     * @deny (delete) Non-admins cannot delete classes.
     * @principle Restricts class management to admins.
     */
    match /classes/{classId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for attendance records within a specific class. Only admins can create, update, or delete attendance records.
     * @path /classes/{classId}/attendance/{attendanceId}
     * @allow (get) Only admins can get an attendance record.
     * @allow (create) Only admins can create an attendance record.
     * @deny (create) Non-admins cannot create attendance records.
     * @deny (update) Non-admins cannot update attendance records.
     * @deny (delete) Non-admins cannot delete attendance records.
     * @principle Restricts attendance management to admins.
     */
    match /classes/{classId}/attendance/{attendanceId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for classrooms. Only admins can create, update, or delete classrooms.
     * @path /classrooms/{roomId}
     * @allow (get) Any user can read classroom information.
     * @allow (create) Only admins can create a classroom.
     * @deny (create) Non-admins cannot create classrooms.
     * @deny (update) Non-admins cannot update classrooms.
     * @deny (delete) Non-admins cannot delete classrooms.
     * @principle Restricts classroom management to admins.
     */
    match /classrooms/{roomId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for user feedback. Any signed in user can create feedback, but no one can read it.
     * @path /feedback/{feedbackId}
     * @allow (create) Any signed in user can create feedback.
     * @deny (get) No one can read feedback.
     * @deny (list) No one can list feedback.
     * @deny (update) No one can update feedback.
     * @deny (delete) No one can delete feedback.
     * @principle Allows users to submit feedback while protecting the privacy of existing feedback.
     */
    match /feedback/{feedbackId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for student timetable data. Publicly readable, but only admins can modify.
     * @path /studentTimetable/{entryId}
     * @allow (get) Any user can read student timetable data.
     * @allow (create) Only admins can create student timetable entries.
     * @deny (create) Non-admins cannot create student timetable entries.
     * @deny (update) Non-admins cannot update student timetable entries.
     * @deny (delete) Non-admins cannot delete student timetable entries.
     * @principle Restricts timetable management to admins, allows public read.
     */
    match /studentTimetable/{entryId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for lecturer timetable data. Publicly readable, but only admins can modify.
     * @path /lecturerTimetable/{entryId}
     * @allow (get) Any user can read lecturer timetable data.
     * @allow (create) Only admins can create lecturer timetable entries.
     * @deny (create) Non-admins cannot create lecturer timetable entries.
     * @deny (update) Non-admins cannot update lecturer timetable entries.
     * @deny (delete) Non-admins cannot delete lecturer timetable entries.
     * @principle Restricts timetable management to admins, allows public read.
     */
    match /lecturerTimetable/{entryId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}