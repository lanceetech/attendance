/**
 * @fileoverview Firestore Security Rules for ClassSync.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with an admin role and owner-based restrictions where appropriate.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the document ID matching the Firebase Auth UID.
 * - /units/{unitId}: Stores information about course units.
 * - /classes/{classId}: Stores details about scheduled class sessions.
 * - /classes/{classId}/attendance/{attendanceId}: Stores attendance records for specific classes.
 * - /classrooms/{roomId}: Stores information about classrooms.
 * - /feedback/{feedbackId}: Stores user feedback.
 * - /studentTimetable/{entryId}, /lecturerTimetable/{entryId}: Denormalized timetable data.
 *
 * Key Security Decisions:
 * - Users can only read their own profile data.
 * - Only admins can create, update, or delete units, classes, and classrooms.
 * - Attendance records can only be created by admins.
 * - Feedback can be created by any signed-in user, but only admins can read or delete it.
 * - Timetable entries are publicly readable, but only admins can modify them.
 *
 * Denormalization for Authorization:
 * - The `lecturerId` field in the `/classes/{classId}` document is used to quickly check if a user is authorized to modify a class.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read their own profile data and admins to manage all user data.
     * @path /users/{userId}
     * @allow (get, list) if isSignedIn() && isOwner(userId)
     * @allow (create, update, delete) if isSignedIn() && isAdmin()
     * @deny (create, update, delete) if !isSignedIn() || !isOwner(userId)
     * @principle Enforces document ownership for reads and admin-only writes.
     */
    match /users/{userId} {
      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && request.auth.uid == userId; //Force user to only be able to update their own userId
      allow delete: if false;
    }

    /**
     * @description Allows admins to manage course units.
     * @path /units/{unitId}
     * @allow (get, list) if true;
     * @allow (create, update, delete) if isSignedIn() && isAdmin()
     * @deny (create, update, delete) if !isSignedIn() || !isAdmin()
     * @principle Restricts write access to admins only.
     */
    match /units/{unitId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows admins to manage class schedules.
     * @path /classes/{classId}
     * @allow (get, list) if true;
     * @allow create: if isSignedIn() && isAdmin();
     * @allow update: if isSignedIn() && isAdmin();
     * @allow delete: if isSignedIn() && isAdmin();
     * @deny (create, update, delete) if !isSignedIn() || !isAdmin()
     * @principle Restricts write access to admins only.
     */
    match /classes/{classId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows admins to manage attendance records for a specific class.
     * @path /classes/{classId}/attendance/{attendanceId}
     * @allow (get, list) if isSignedIn() && isAdmin()
     * @allow create: if isSignedIn() && isAdmin()
     * @allow update: if isSignedIn() && isAdmin()
     * @allow delete: if isSignedIn() && isAdmin()
     * @deny (create, update, delete) if !isSignedIn() || !isAdmin()
     * @principle Restricts access to attendance records to admins only.
     */
    match /classes/{classId}/attendance/{attendanceId} {
      allow get, list: if isSignedIn() && isAdmin();
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows admins to manage classroom data.
     * @path /classrooms/{roomId}
     * @allow (get, list) if true;
     * @allow create: if isSignedIn() && isAdmin();
     * @allow update: if isSignedIn() && isAdmin();
     * @allow delete: if isSignedIn() && isAdmin();
     * @deny (create, update, delete) if !isSignedIn() || !isAdmin()
     * @principle Restricts write access to admins only.
     */
    match /classrooms/{roomId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows signed-in users to create feedback, but only admins can read or delete it.
     * @path /feedback/{feedbackId}
     * @allow get, list: if isSignedIn() && isAdmin()
     * @allow create: if isSignedIn()
     * @allow update: if false;
     * @allow delete: if isSignedIn() && isAdmin();
     * @deny create: if !isSignedIn()
     * @deny get, list: if !isSignedIn() || !isAdmin()
     * @deny delete: if !isSignedIn() || !isAdmin()
     * @principle Allows users to submit feedback, but restricts management to admins.
     */
    match /feedback/{feedbackId} {
      allow get, list: if isSignedIn() && isAdmin();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows anyone to read timetable data, but only admins can modify it.
     * @path /studentTimetable/{entryId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && isAdmin();
     * @allow update: if isSignedIn() && isAdmin();
     * @allow delete: if isSignedIn() && isAdmin();
     * @deny (create, update, delete) if !isSignedIn() || !isAdmin()
     * @principle Provides public read access with admin-only writes.
     */
    match /studentTimetable/{entryId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows anyone to read timetable data, but only admins can modify it.
     * @path /lecturerTimetable/{entryId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && isAdmin();
     * @allow update: if isSignedIn() && isAdmin();
     * @allow delete: if isSignedIn() && isAdmin();
     * @deny (create, update, delete) if !isSignedIn() || !isAdmin()
     * @principle Provides public read access with admin-only writes.
     */
    match /lecturerTimetable/{entryId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin() {
    return isSignedIn() && request.auth.token.role == 'admin';
  }
}