rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get, update, delete) if isSignedIn() && isOwner(userId)
     * @allow (create) if isSignedIn() && isNewUser(userId)
     * @deny (list) always
     * @deny (create) if isSignedIn() && !isNewUser(userId)
     * @deny (update, delete) if !isSignedIn() || !isOwner(userId)
     * @principle Enforces document ownership and verified identity.
     */
    match /users/{userId} {
      // Only the user and admins can read their own profile.
      allow get: if isSignedIn() && isOwner(userId);
      // Only the user can create their own profile, but only once.
      allow create: if isSignedIn() && isNewUser(userId);
      // Only the user can update their own profile.
      allow update: if isSignedIn() && isOwner(userId);
      // Only the user can delete their own profile.
      allow delete: if isSignedIn() && isOwner(userId);

      // No listing of users.
      allow list: if false;
    }

    /**
     * @description Controls access to unit information.
     * @path /units/{unitId}
     * @allow (get, list) always
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Enforces admin-only writes.
     */
    match /units/{unitId} {
      // Anyone can read unit information.
      allow get, list: if true;
      // Only admins can create, update, and delete units.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to class information.
     * @path /classes/{classId}
     * @allow (get, list) always
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Enforces admin-only writes.
     */
    match /classes/{classId} {
      // Anyone can read class information.
      allow get, list: if true;
      // Only admins can create, update, and delete classes.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to attendance records for a specific class.
     * @path /classes/{classId}/attendance/{attendanceId}
     * @allow (get, list) if isAdmin()
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete, get, list) if !isAdmin()
     * @principle Enforces admin-only access for attendance records.
     */
    match /classes/{classId}/attendance/{attendanceId} {
      // Only admins can read attendance records.
      allow get, list: if isAdmin();
      // Only admins can create, update, and delete attendance records.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to classroom information.
     * @path /classrooms/{roomId}
     * @allow (get, list) always
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Enforces admin-only writes.
     */
    match /classrooms/{roomId} {
      // Anyone can read classroom information.
      allow get, list: if true;
      // Only admins can create, update, and delete classrooms.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to feedback submissions.
     * @path /feedback/{feedbackId}
     * @allow (get, list) always
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Enforces admin-only writes.
     */
    match /feedback/{feedbackId} {
      // Anyone can read feedback submissions.
      allow get, list: if true;
      // Only admins can create, update, and delete feedback.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to student timetable data.
     * @path /studentTimetable/{entryId}
     * @allow (get, list) always
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Enforces admin-only writes.
     */
    match /studentTimetable/{entryId} {
      // Anyone can read the student timetable.
      allow get, list: if true;
      // Only admins can create, update, and delete student timetable entries.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to lecturer timetable data.
     * @path /lecturerTimetable/{entryId}
     * @allow (get, list) always
     * @allow (create, update, delete) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Enforces admin-only writes.
     */
    match /lecturerTimetable/{entryId} {
      // Anyone can read the lecturer timetable.
      allow get, list: if true;
      // Only admins can create, update, and delete lecturer timetable entries.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isNewUser(userId) {
    return !exists(/databases/$(database)/documents/users/$(userId));
  }

  function isAdmin() {
    return request.auth.token.role == 'admin';
  }
}